<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Extend a Docker image on the fly, without defining a new image</title><base href="/"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="manifest" href="/site.webmanifest"/><link rel="icon" type="image/x-icon" href="/favicon.ico"/><meta name="next-head-count" content="6"/><link rel="preload" href="/_next/static/css/2ae64d7585f44ddd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2ae64d7585f44ddd.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-0f57bbafd28fc3ce.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-dffcc8d986d9cae7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-15876a5edecd0ad2.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bpath%5D-e5a9ef94e1c1e9db.js" defer=""></script><script src="/_next/static/JFjYMyLY5fY4zKMZ0y4vE/_buildManifest.js" defer=""></script><script src="/_next/static/JFjYMyLY5fY4zKMZ0y4vE/_ssgManifest.js" defer=""></script><script src="/_next/static/JFjYMyLY5fY4zKMZ0y4vE/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div class="container"><div class="row mb-4 mt-4"><div class="col-8 offset-2"><a href="/">Go back</a><h1>Extend a Docker image on the fly, without defining a new image</h1><p class="text-muted">December 2, 2021</p></div></div><div class="row"><div class="col-8 offset-2"><div style="font-size:150%"><p>If you want to use a particular Docker image but you need to apply some changes to it, the correct way to go is to extend that image and build your own on top of it. So basically, you will have to create a new <code>Dockerfile</code> with <code>FROM: alpine</code> or whatever is your source image, followed by a set of instructions where you apply the customization you need in your image. For instance, you could install your application executable and all the dependencies it needs.</p>
<h2 id="but-what-if-you-dont-want-to-create-a-new-docker-image">But what if you don&#39;t want to create a new Docker image?</h2>
<p>In some situations, it doesn&#39;t make much sense to extend an existing image. For instance, for a personal use application (<strong>not a production one</strong>) that you don&#39;t want to maintain, where all the customization you need is installing one or two additional packages. In that case, it would be easier to just install the packages and then run the command the image is meant to run by default. But first, let&#39;s give a look at the <code>docker run</code> command.</p>
<p>This is what the official documentation tells us:</p>
<pre><code>docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]
</code></pre>
<p>The <code>COMMAND</code> option allows us to specify an optional command to run when the container starts. For instance, if we want to spawn a new container and get a shell for testing, we could do the following.</p>
<pre><code>docker run -it --rm alpine sh
</code></pre>
<p>It will spawn a new container in interactive mode and once it&#39;s up it will run the <code>sh</code> command. So this is a good way to test the commands we want the container to run. Once we know the commands, we could add them to a script like this.</p>
<pre><code>#/usr/bin/env sh

apk add s-nail
sh
</code></pre>
<p>Let&#39;s name it <code>start.sh</code> and don&#39;t forget to make this script executable: <code>chmod +x start.sh</code>. Also, remember to replace the Shebang line <code>#/usr/bin/env sh</code> with the most suitable one for your image. For instance, if you&#39;re not using Apline but another image with Bash, you may want to replace it with <code>#/usr/bin/env bash</code>.</p>
<p>So now we could mount this script and pass its path to the <code>COMMAND</code> option when running <code>docker run</code>.</p>
<pre><code>docker run -it -v &quot;$(pwd)/start.sh&quot;:/start.sh alpine /start.sh
</code></pre>
<p>Now we get a shell, as before, but before that the container will install S-nail. We&#39;re almost there.</p>
<p>Probably we don&#39;t want to get an interactive shell, but rather execute the default command the image was meant to run. For instance, if that container is a Nextcloud instance, we want it to start Nextcloud when we do <code>docker run</code>. But what&#39;s the command for that?</p>
<p>In general, when a container starts, it will run the <code>CMD</code> specified in the <code>Dockerfile</code>. The most accurate way to find it is</p>
<ul>
<li>to go to <a href="https://hub.docker.com/">Docker Hub</a>,</li>
<li>search for your image,</li>
<li>open the Tags tab,</li>
<li>select the exact version you want to use, or <code>latest</code> otherwise,</li>
<li>on the left, search for the latest occurrence of the <code>CMD</code> definition.</li>
</ul>
<p>That&#39;s the command you want to append to your <code>start.sh</code> script instead of the <code>sh</code> one. For instance, for <a href="https://hub.docker.com/layers/nextcloud/library/nextcloud/stable-fpm-alpine/images/sha256-5aded1c55b126768ed6f54c5ff30b4622432198905b47f12c052d87d9cb6131e?context=explore">this Nextcloud image</a>, the command the container will run by default is <code>php-fpm</code>.</p>
</div></div></div></div><p class="text-center small mt-5">Copyright Â© <!-- -->2021<!-- --> Egidio Caprino. All rights reserved.</p></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":7,"title":"Extend a Docker image on the fly, without defining a new image","name":"extend-a-docker-image-on-the-fly-without-defining-a-new-image","date":1638454534,"content":"\u003cp\u003eIf you want to use a particular Docker image but you need to apply some changes to it, the correct way to go is to extend that image and build your own on top of it. So basically, you will have to create a new \u003ccode\u003eDockerfile\u003c/code\u003e with \u003ccode\u003eFROM: alpine\u003c/code\u003e or whatever is your source image, followed by a set of instructions where you apply the customization you need in your image. For instance, you could install your application executable and all the dependencies it needs.\u003c/p\u003e\n\u003ch2 id=\"but-what-if-you-dont-want-to-create-a-new-docker-image\"\u003eBut what if you don\u0026#39;t want to create a new Docker image?\u003c/h2\u003e\n\u003cp\u003eIn some situations, it doesn\u0026#39;t make much sense to extend an existing image. For instance, for a personal use application (\u003cstrong\u003enot a production one\u003c/strong\u003e) that you don\u0026#39;t want to maintain, where all the customization you need is installing one or two additional packages. In that case, it would be easier to just install the packages and then run the command the image is meant to run by default. But first, let\u0026#39;s give a look at the \u003ccode\u003edocker run\u003c/code\u003e command.\u003c/p\u003e\n\u003cp\u003eThis is what the official documentation tells us:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003eCOMMAND\u003c/code\u003e option allows us to specify an optional command to run when the container starts. For instance, if we want to spawn a new container and get a shell for testing, we could do the following.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker run -it --rm alpine sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt will spawn a new container in interactive mode and once it\u0026#39;s up it will run the \u003ccode\u003esh\u003c/code\u003e command. So this is a good way to test the commands we want the container to run. Once we know the commands, we could add them to a script like this.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e#/usr/bin/env sh\n\napk add s-nail\nsh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet\u0026#39;s name it \u003ccode\u003estart.sh\u003c/code\u003e and don\u0026#39;t forget to make this script executable: \u003ccode\u003echmod +x start.sh\u003c/code\u003e. Also, remember to replace the Shebang line \u003ccode\u003e#/usr/bin/env sh\u003c/code\u003e with the most suitable one for your image. For instance, if you\u0026#39;re not using Apline but another image with Bash, you may want to replace it with \u003ccode\u003e#/usr/bin/env bash\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eSo now we could mount this script and pass its path to the \u003ccode\u003eCOMMAND\u003c/code\u003e option when running \u003ccode\u003edocker run\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker run -it -v \u0026quot;$(pwd)/start.sh\u0026quot;:/start.sh alpine /start.sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we get a shell, as before, but before that the container will install S-nail. We\u0026#39;re almost there.\u003c/p\u003e\n\u003cp\u003eProbably we don\u0026#39;t want to get an interactive shell, but rather execute the default command the image was meant to run. For instance, if that container is a Nextcloud instance, we want it to start Nextcloud when we do \u003ccode\u003edocker run\u003c/code\u003e. But what\u0026#39;s the command for that?\u003c/p\u003e\n\u003cp\u003eIn general, when a container starts, it will run the \u003ccode\u003eCMD\u003c/code\u003e specified in the \u003ccode\u003eDockerfile\u003c/code\u003e. The most accurate way to find it is\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eto go to \u003ca href=\"https://hub.docker.com/\"\u003eDocker Hub\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003esearch for your image,\u003c/li\u003e\n\u003cli\u003eopen the Tags tab,\u003c/li\u003e\n\u003cli\u003eselect the exact version you want to use, or \u003ccode\u003elatest\u003c/code\u003e otherwise,\u003c/li\u003e\n\u003cli\u003eon the left, search for the latest occurrence of the \u003ccode\u003eCMD\u003c/code\u003e definition.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThat\u0026#39;s the command you want to append to your \u003ccode\u003estart.sh\u003c/code\u003e script instead of the \u003ccode\u003esh\u003c/code\u003e one. For instance, for \u003ca href=\"https://hub.docker.com/layers/nextcloud/library/nextcloud/stable-fpm-alpine/images/sha256-5aded1c55b126768ed6f54c5ff30b4622432198905b47f12c052d87d9cb6131e?context=explore\"\u003ethis Nextcloud image\u003c/a\u003e, the command the container will run by default is \u003ccode\u003ephp-fpm\u003c/code\u003e.\u003c/p\u003e\n","formattedDate":"December 2, 2021"},"__N_SSG":true},"page":"/articles/[path]","query":{"path":"7-extend-a-docker-image-on-the-fly-without-defining-a-new-image"},"buildId":"JFjYMyLY5fY4zKMZ0y4vE","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>